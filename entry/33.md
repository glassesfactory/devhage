# サーバー/クライアントを繋ぎこむ上での設計について

Twitter や Facebook を眺めていたら、
サーバーとクライアントを繋ぎこむ上でどのような設計にしたらいいのか  
悩んでいる人がわりかしいたので  
事例紹介というほどではないですが、  
ちょっと自分なりに普段どうしているか、どういうことで失敗してしまったかということを  
自戒を込めつつメモ書きを並べてみようと思います。

僕自身あの時こうしていればよかっただとか未だにしょっちゅう後悔しているので  
「これがベストプラクティスだ！」とか「good parts!」などと言い切るつもりは毛頭はありませんし  
わりかし基本的なこともあえて書いていたりするのでそこはご愛嬌を。

むしろ指摘して欲しいぐらいだったりしますが。  
とりあえず僕自身の経験を含めて切々と書いていきます。

## meta

- slug: 33
- date: 2013-11-28 09:10:41
- active: true


## content

## 考えてみること-----------------------------------

考えるべきことは色々あるのですが  
挙げだすときりがないので  
今日のところはまず、以下のことについて考えてみたいと思います。

* API との通信を一元化する
* データをどう取り扱うべきか
* サーバーからの戻り値とクライアントサイドで扱う変数名前を極力揃える

## API との通信を一元化する--------------------------------------------

クライアントからサーバーに対してリクエストを投げる時、
色々なクラスやモジュールから無闇矢鱈にリクエストを投げる実装を書くのではなく  
ある程度一元化したほうがバグ探索や追加仕様に対して柔軟に対応出来るのでは無いかと考えます。

Flash でいう `flash.net.URLLoader` や、JS でいう `$.ajax` といったような実装を、  
`Controller` なり `ViewModel` などといった `View` や `Model` を操作するような箇所に直接書くのではなく、  
それらをラップするクラスを用意し、実際に API に対してアクセスするのはそのクラスのみ  
と言った状況にしておくのが好ましいのではと考えます。

こうすることで発生するメリットとしては

* 突然の仕様変更で通信時につけるパラメーターが変わったり、暗号化する必要が出てきた場合、変更するのは1箇所で済む
* API にアクセスする際必ず経由させることで、通信が絡む箇所でのバグ発生時に探索がしやすくなる
* 主に演出を担当する人間に生の通信ロジックを意識させずに済む

といったようなことが挙げられます。

## 送受信するデータの取扱い

次に、送受信するデータをどう取り扱うべきかということについて考えてみようと思います。

僕の場合はサーバーとの通信に限った話ではないですが、
手続きを抽象化した `Context` クラスを用意し、それらによってサーバーと演出側の橋渡しを行います。

クライアント側からデータを送信したい場合は `generateHogeContext( …args )` など生成用の手続きを用意し、それらを用いて `Context` を生成してもらいます。
API へ送信時には生成した `Context` ごと投げ入れてもらいます。

サーバーから来たデータは、フォーマットに合わせてパース。
`Context` として生成しなおして演出側へ引き渡します。

この `Context` の目的は極力、生で Object や Array を渡り歩かせることを避けることを目的としています。  
生の Object や Array では `key/value` に対して型の保証が完全ではなくなるため  
サーバーから演出側への実装上の距離が遠くなればなるほど、受け渡しのリスクが高くなってしまうためです。

もちろん末端のモジュールに対しては、そのまま `Context` を渡すのではなく、  
`Context` から必要な物だけを取り出して渡してあげることが理想だと言えます。  
`Context` に末端のモジュールが必要とするプロパティが複数ある場合は生成用のメソッドなどを用意してあげるとよいでしょう。

また、場合によっては `Context` 自体が更に `Context` を持つリレーショナルな実装も考慮すべきだと思われます。

## 変数名を揃える

ここは API を構築する方と要相談ですが、  
極力サーバーとクライアント間で扱う変数名を揃えておいたほうが効率的に物事が進むのではと  
自分の経験上は考えています。  
少なくとも、ローカルに DB を持つような実装をする場合はローカルでのカラム名とサーバー上でのカラム名は極力揃えておいたほうが  
無駄なパースを挟まなくて済むと思われます。

例えば JSON フォーマットでやりとりする場合、極力キャメルキャプションは避けたいところですが、  
クライアントが AS3 での実装の場合、スニークキャプションよりはキャメルキャプションが推奨されています。  
その場合は、カラム名としてはスニークキャプションを使用しつつ、`Model` のメンバとしてはキャメルキャプションにしておく  
と言った気を利かせると他の人が喜ぶと思われます。

今日のところはこの程度にしておきます。  
気が向いたら上記について、じゃあどう実装してみるかということについても書いてみようと思います。  
それでは。
