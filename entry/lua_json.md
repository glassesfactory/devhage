# nginx + Lua で post されてきた json を保存

[前回の記事](https://dev.hageee.net/newblog/) でサラッと触れたが、  
このブログの記事詳細データは nginx + lua で post されてきたデータを json ファイルとして生成している。

というわけでそのサラッと触れた部分について書こうと思う。


## meta

- slug: lua_json
- date: 2015-12-21 11:11
- tags: blog, lua
- active: true


## content

## lua ?

昔からあるスクリプト言語。ゲームの演出作ったりするのにも使われている。  
nginx に lua-nginx-module というのを入れると  
その lua が nginx から直接実行することができるようになる。

それのなにが美味しいかというと、まさに表題にあるような簡単な処理を実行したい時だ。  
飛んできた JSON フォーマットなデータを静的ファイルとしてただ保存したいだけなので、
そこに + α して html を出力するぐらいが加わったところでたかだかそれだけのために  
CMS や WAF を導入するのもなかなかバカバカしくなる話だ。

CMS や WAF を入れたら今度はそれらを動かすプロセスも管理する必要が出てくるので、
これまためんどくさい。  
でもシェルスクリプトで全部書くにはしんどいしな…という状況にうってつけなのが nginx + lua という選択肢だ。

nginx に lua-nginx-module を導入するような記事はすでに山ほどあって  
"lua-nginx-module インストール" とかで検索すればすぐ出てくると思うのでわざわざ解説はしない。

表題にある JSON を保存することについて書くのだけれど、  
正直わざわざタイトルにするのが恥ずかしくなるくらい、手を付けてみると簡単に思ったような処理ができるのが便利だなポイントだった。

## やったこと

とりあえずソースはこのブログのリポジトリにある。

[github](https://github.com/glassesfactory/devhage/blob/master/tools/make_static.lua)

ざっくり流れを挙げてみる

* `ngx.req.read_body()` で lua から nginx に来ている request の body を読めるようにする。  
* `ngx.req.get_body_data()` で body のデータを手に入れる。
* 一定サイズ(8kだか16kだか)を越えた時、tmp ディレクトリにファイルとして置かれているのでそっちを読む
* json としてパース。必要な情報(slugって項目をファイル名としている。)を抜き出す。
* ファイルとして保存
* ついでに fb とか用の meta タグだけな html を吐く。

description 周りの strip_tag 的な処理が中途半端になってるのは内緒です。

書いたとおり、その辺に落ちてるようなサンプルというか先人たちのやってみた系を  
組み合わせた程度のもので、全然威張れるようなことはしてないですな。

## 引っかかったところ

工夫した点というべきではないのだろうけど、  
めんどくさかったこととしては、lua 自体昨日今日ぽっと出てきた言語ではないので微妙に情報が古かったりして
書いてあることがそのまま使えなかったりとかある程度自己検証と取捨選択が必要。それもまた普通のことですね。  
(覚えてないけど確かファイルの取扱とか)

それと、 lua のモジュール管理で luarocks というのがあるのだけれどこれを使う上で unzip がインストールされてる必要がある。  
インストール時に大きく書かれているわけではないため、見落としがちなので注意。

テンプレートエンジンは OpenResty とか入れてればそっちを使うのだが、  
このサーバーではこれ意外特にやるつもりはなかったので単一のテンプレートエンジンだけが欲しかったので  
あれこれ調べたら懐かしの(失礼) mustache の lua 版があったのでそちらを使った。  
React だ Riot だなんだというフロントエンド戦場にいる身としては心がほっこりしたのは内緒だ。

とりあえず lua + nginx が便利なんで今後も積極的に使っていこうと思いましたとさ。
