# Riot.js 試したかったのでブログを書き直した

Riot.js を試したかったのでブログを Riot.js で書き直した。

CSS のスコープ化など、CSS の再設計を要するため余した部分はあるが  
思い立ってから仕事の合間を縫って述べ JavaScript 的なロジック部分に関しては  
1日かからずに書き換え終わった。

一応これでもこのブログも SPA ライクな作りはしているので、  
一度でも SPA を作ったことがある人なら  
いかに気軽に書くことができるか想像につくかと思う。

寧ろこの文章書いてる方が時間かかった気さえする。

全ての機能を触ったわけではないが、  
とりあえず1本書ききったので読書感想文と実装で躓いたところを書きなぐってみる。

## meta

- slug: riot
- date: 2016-12-02 11:11
- tags: riot,js
- active: true

## content

## Riot とは

これ読んで下さい。

> [http://riotjs.com/v2/ja/](http://riotjs.com/v2/ja/)

Riot.js 自体の最新版は執筆時点で v3 なのだが、  
どういうものなのかを理解するには十分だと思う。

また、サンプルもシンプルに纏まっているので  
ある程度コードが読める人なら先にコードから読んだほうが  
ノリがつかみやすいと思われる。

> [https://github.com/riot/examples](https://github.com/riot/examples)

## 実装ハマりポイント幾つか

というわけで、上で紹介した v2 の日本語訳や  
公式のサンプルを見てもらえれば基本的な実装方法はわかってもらえるとして、  
ドキュメントの中で多少埋まっていたり、  
あまり触れられてない部分で  
ブログを書き直す上で自分が調べたような事を幾つか書こうと思う。

### ルーターでハッシュを使わない

Riot.js では SPA でのルーティング用として riot-route が別途公開されている。  
導入自体は簡単でほぼほぼ README 通りではあるが、  
`nam install —save riot-route` でプロジェクトに追加した後、  
以下の用に書けば URL が riot-route の監視下に置かれる。

    let r = route.create();

    r('/', ()=>{
      /* index */
    });
    r('/entry/*', ()=>{
      /* show resources detail */
    });

    route.start(true);

しかしこのままだと URL にハッシュフラグメント(#)を付けなければ  
ルーティングが実行されない。

これでは困る。  
ドキュメントをよく読むとひっそりこんな一文が。

> [http://riotjs.com/api/route/#routebasebase](http://riotjs.com/api/route/#routebasebase)

> The default base value is “#”. If you’d like to use hashbang, change it to #!.
> If you remove the # from the base, your web server needs to deliver your app no matter what url comes in, because your app, in the browser, is manipulating the url. The web server doesn’t know how to handle the URL.

要訳するとハッシュかしとかんと通常の Web サーバー(多分レンタルとか?)では  
ディープリンクに直アクセス出来ないからと言っている気がする。

今日日 pushSatet でディープリンクを拾う方法なんていくらでも転がっている気がするので  
その辺は気にしなくてもいい気がするけどなぁ。

そして紹介されている `route.base('#!’)` では意図した URL にならなかった。  
結局 `route.base(‘/‘)` と書いたら解決した。

### HTML タグを含んだテキストのインジェクション

なんだかんだ言って実案件の既存 CMS にフロントを当てるような案件だと、  
普通に HTML タグ入りのテキストが飛んでくる。  
世の中正規化されたことばかりじゃないんだね。み○を。

最近はいろんな手法が確立されたので、  
フロントは確かに多少大きな規模だろうとガンガン入れ替えられるようになった気はするが  
運用ばかりはそうは行かない。行かせてくれないんだよ…

しょうがないのであわせてあげることにすると HTML タグのインジェクションが必要になってくる。  
XSS の危険性もあるし推奨出来ないけどそれはそれ、これはこれ。

一応 React だと以下のようにして HTML タグ入りテキストを挿入できる。

<script src="https://gist.github.com/glassesfactory/af9460c66b6fc1b79727685f48169b63.js"></script>

思いっきり dangerously とか言われてる。  
ちなみに自分はちゃんとタグをパースしてサニタイズと React でエレメント作って変換するヘルパー書きましたよ。

例に漏れず Riot もその辺の XSS を考慮した思想はもっているようで、  
HTML タグ入りテキストをテンプレートに渡すとそのまま出力される。

<script src="https://gist.github.com/glassesfactory/5ad1c53f8616a6d73274a8c8cc111ea5.js"></script>

しかし、Riot には React の dangerouslySetInnerHTML 的な禁術は用意されていない様子。  
ググっても出てこないので結局以下のような方法にした。

<script src="https://gist.github.com/glassesfactory/488918eff2affb1fc0b0f5f36d2392f8.js"></script>

React と違って DOM を仮想 DOM でガッチリ食ってるわけでは無いようなので  
容赦のない変更を図る。  
実案件では HTML タグ入りテキストをタグ活かして表示しなきゃいけない時点で  
ほぼ負けてるのでそこはひとつ目を瞑ってそのまま寝よう。

力技臭がプンプンするのだけれど、このあたり実際のところを知っている人がいたら教えてください。

### child タグへのプロパティ渡し

React で言う、親から子へのプロパティ渡し。

<script src="https://gist.github.com/glassesfactory/0bc13a2c2c49bdb0746b0bfd2eb4c1a3.js"></script>

っぽいサンプルやドキュメントの記述が無いのでいまいちわかりづらいが、  
一応似たようなことはできる。

<script src="https://gist.github.com/glassesfactory/f4afa22bf20c6b760bc0e6e018138727.js"></script>

React を経験するとすごく初歩的な親子関係を表す構図にも見えるが、  
Riot 的にはそうでもないらしい。  

そんなの当たり前だろ前提なのか、できれば使ってほしくないのかどちらか知らないが。  
こういったタグにタグをマウントするようなサンプルもないし  
過去に遡って議論を見たりもしてないのでその判断もつかない。

肝は `opts` は、サンプルだから `opts` としているわけではなく、  
実際に `opts` でアクセスできる。まじで。

一応この `opts.text`  のヒントになりそうなことは以下に書いてある。

> [http://riotjs.com/api/#tag-instance](http://riotjs.com/api/#tag-instance)

問題はドキュメントを頭から読んでいてもそもそもこの `opts` とかいうよくある名前の変数が  
グローバル変数のごとく無条件で呼べるとは一言も書いてないことだ。

これは自分はハマったと言うよりはサンプルなかったりドキュメントにも書いてないけど  
React と同じノリで行けるだろと試しに書いたら動いた。

他にも暗黙的にしれっと書かれてることが幾つかあるようなので注意すること。

なんとなくだけど、Riot は React はしんどそうだけど  
これなら自分でも使えそうでやってくるユーザーが多い気はするので  
この件は Riot 的にアリなら1個ぐらいサンプルなり  
ドキュメントの一例なり用意した方がいいと思うなおじさんは。

### いちいち React に乗っ取られてる

どうでもいいんだけど riot template だとか riot routing だとかでググると、  
毎回 「もしかして react template」だったり、  
「react routing の検索結果を表示しています。」と出る。

気付かずに Riot の情報少ないなぁと思うと  
悲しい目に合うので google には気をつけたほうがいい。

もしかして SEO 弱い?  
~~ハッシュ推奨してるから省かれてるんじゃね~~

とまぁ、ハマったというか割とググったようなことはこれぐらい。

## 経緯

最近仕事では React を中心に使っていて、  
1年以上比較的大規模なサイトにコミットし続けている。

そのサイトの周辺コンテンツを眺めていると  
なんだか React 使おうとして爆死したり Vue.js 使おうとして爆死したりしていて、  
そもそも要求されているコンテンツの規模に対して  
ライブラリの規模が合っていないなぁと感じていた。

薄々なんで Riot 選択肢に入ってこないんだろうと思っていたのだが、  
ここ直近で大きめな爆死を2回連続で見てしまい目も当てられないので  
ちょっと自分が Riot をもう少し触って提案してあげようと思った次第。

## React との比較

いつものように殴り書きの個人の感想。

React は比較的大規模を見据えていると思っているのに対し、  
Riot.js は小規模から中規模をさくっと作るのに向いていると思う。  
ただ Riot の `yield` を試しきれてないので場合によっては化けるのかなぁと思った。  
が、どうだろう。  
そこに対しては触ってからコメントすることにする。

### Riot のいいところ

* API がシンプルで少ない
* 古き良き HTML の延長線の気持ちでかける

### React のいいところ

* API が色々ある
* JavaScript な気持ちで書ける

メリットデメリットはケースバイケースの表裏一体が座右の銘なので(今思いついた)  
見事に互いのメリットがデメリットになっている。  
それぞれがどういう意味を持っているのかは  
賢いみんななら言わずともわかると思うので書くのめんどくさいし書かないね。

早い話が作るなり設計を担当する人間がきちんと規模感把握しようなという一言に尽きる。

React と Riot のコードを並べると、ぱっと見同じように見えるかもしれないが、  
最終的には HTML に JS を書くのが嫌か、JS に HTML 的なものを書くのが嫌かという  
宗教対立的な話になるので、どちらかの原理主義者と話す時は  
トップでバスが出たときの興奮でも思い出して適当にテンションだけ合わせておこうと思う。

要約すると、

* 小さくまとめたいときは小さくまとめられる Riot
* 拡張性含めガリガリした MV* だの flux だのが必要な高度なアプリケーションを作るときは React

と覚えて帰ってくれればいいと思う。

## 所感

とりあえず、想定通り React で作るほどでもない小さなアプリケーションを  
思ったようなソースコード量で書くことが出来た。

riot-route について、調べていたら `/foo/<bar>/<over>` みたいな URL はちょっと怪しい  
みたいな一文も見かけたこともありつつ  
1 resources ぐらいの実装で済むなら Riot で、  
それ以上だったり少し複雑なルーティングが絡むようなら React で組む  
と言った使い分けがいいのではないかと思った。

マイクロサービス指向と言うべきか、  
ドキュメントにサービス指向性をもたせたと言うべきか宗教観の違いは出る気はするが。

とりあえず案ずるより産むが易しなので何はともあれ書いてみるといいと思います。
