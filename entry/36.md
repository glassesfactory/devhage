# Adobe AIR Advent Calendar 25日目: AIR for iOS / Android でデータの再送信処理を実装する

この記事は [Adebe AIR Advent Calendar 25日目](http://www.adventar.org/calendars/182)の記事です。

最終日ですがなんだかんだ言って記事が思ったより集まったのでよかったなぁと思っています。

さて、今回の内容ですがゲームやツールを作る上で  
サーバーに情報を送信しようとしたのに失敗してしまった時どう処理しようか、という話です。

ツイッタークライアントなどでよく実装されている下書き機能などがそれに該当すると思われます。

今回はマイクロブログサービスのクライアントという想定で話を進めたいと思います。

## meta

- slug: 36
- date: 2013-12-25 13:10:17
- active: true

## content

## データの取扱

さて、送信失敗時の対処を考慮した上でデータをどう取り扱うべきか考えてみましょう。

まず、前提条件として  
送信に失敗したデータは「下書き」領域に持って行くこととして、  
メインのタイムラインには表示させないことにします。

その前提条件を元にすると、  
メインタイムライン用のデータを保存するタイミングは  
送信が成功した時ということになるかと思います。

つまりデータに下書きかどうかのフラグをもたせる必要はない  
ということになります。

## 仮想データ

とりあえず、話を進める上で仮想のデータ設計をしてみましょう。

* 本文
* 投稿時刻
* 投稿ID

それらを踏まえて、ローカルでは以下のようなテーブル構造を持った Model を考えてみます。

<script src="https://gist.github.com/glassesfactory/defcf308360fd0eb3ce1.js">{}</script>

## コンテキスト------------

いつものごとくコンテキストも用意しておきます。  
今回はこのコンテキストが割と役に立ってくれます。

<script src="https://gist.github.com/glassesfactory/34c303e9990197322c1e.js">{}</script>

## 送信失敗時の処理を考える

さて、とりあえず用意するものは用意しました。
では送信失敗した時どういう処理をすべきか考えてみましょう。

まず失敗したらエラーをキャッチしてエラー表示をさせますよね。  
ここについてはサンプル的な実装もいらないと思います。

次に、データを一時的に保存することを考えます。  
送信に失敗したからといって、アプリを落とした時データが消えてしまっては困るので  
一時的な保存用の DB を別で確保し、そこに格納することでここは賄うことにします。

DB を別にしておくことで一時保存用のデータが  
メインタイムラインに出現してしまうことを防ぎます。

## データの再送信

失敗してしまったデータを再送信するタイミングは以下の二つが考えられます。

* ユーザーが任意で再送信を試みる
* バックグラウンドで自動的に送る

通常、マイクロブログのクライアントなどでは前者が  
ゲームのスコア送信などでは後者が採用されることが多いと考えられます。

どちらにせよ、送信失敗時に自動的に一時保存領域にデータを保存するような  
仕組みを実装して上げる必要があります。

## 送信に失敗した一時保存データの定義

送信に失敗した一時保存データは以下の様なテーブルとモデルに保存しておくことにします。

<script src="https://gist.github.com/glassesfactory/bf43ec6fdf7726604927.js">{}</script>

 ここで、データではなくタスクという概念が登場していますが  
これについては次に説明します。

## 送信失敗時に自動的に保存させる

次に、送信失敗時に自動的に保存するクラスについて考えてみます。  
バックグラウンドで送信させることも考慮すると、  
データを保存するよりはむしろ処理や状態そのものを保存、復元出来るようにしてしまったほうが  
データの再バインディングという地味に失敗しやすい状況を回避することが出来ると思います。

そのためのベースクラスは以下のようになります。

<script src="https://gist.github.com/glassesfactory/f61ab302a4f83176f076.js">{}</script>

そしてこのクラスを継承して、投稿を送信、失敗時に保存するタスククラスを以下のように書いてみました。

<script src="https://gist.github.com/glassesfactory/30eab30d38725fc06650.js">{}</script>

## タスクの復元

後はこのタスクを復元さえしてしまえば、  
何時でも任意のタイミングで再度送信を試みることが出来ます。

タスクの復元は以下のようにして行います。

<script src="https://gist.github.com/glassesfactory/889d2f4ab8b64d2fee06.js">{}</script>

これでタスクが復元できるので  
バックグラウンドでまとめて一気にシリアルで実行するもよし、パラレルで実行するもよし  
リストとして表示しておいて任意のデータ、任意のタイミングでユーザーに送信させるのもよし  
と言った感じです。

------------

長くなって後半やや雑になりましたがこんな感じで  
AIR アプリの送信失敗、再送信処理を実現することが出来ると思います。

とはいえこれはあくまで実装パターンの一例ですので  
データの性質やコンテンツの性質に合わせて様々な方法があると思います。  
ただどんな性質のものであろうと

* 送信すべきタイミング
* ローカルに保存すべきタイミング
* 再送信においてどのような情報が必要か

ということをきっちり切り分けて考えればそれなりの対策は見えてくると思います。

それでは Advent Calendar に参加した皆さん、お疲れ様でした。
