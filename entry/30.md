#Socket.IO と AS3 を直接繋ぐメモ

随分何も書いていない気がしてきたのでちょっとしたメモを落としていきます。

メモなので前段とかは今回はぶち抜きですね。  
某プログラマの情報共有サービスに投稿すればいいんじゃないのと突っ込まれそうですが  
多分そんなに需要のある情報じゃないのでシコシコブログの餌にするのです。

## meta

- slug: 30
- date: 2013-08-23 19:07:20
- active: true


## content

Socket.IO は WebSocket とか flashsocket とか XHR long-polling とか色々楽ちんだぜ  
とよく聞くのですが  
Flash の flash.net.Socket でうまいこと綺麗に接続できたいい思い出がないので  
いつも苦い顔していますね。

自前で WebSocket を実装するのは骨が折れるというか既に使いやすいものがあるのでそれを使いましょう。  
以前このブログでも紹介した [AS3WebSocket](https://github.com/Worlize/AS3WebSocket) を使っています。

## 接続までの流れ


Socket.IO は気軽気軽という話を随所で聞くので  
AS3 でも `socket.connect()` とかで一発でつながるイメージが Socket.IO には有りますが  
それは js というか標準で提供されている socket.io-client.js で実装した時の話であって AS から接続するには  
socket.io-client.js がやってるような手続きを自前でやる必要があります。

つなげるまでの大雑把な手続きは以下

* Socket.IO サーバーに接続時に使用したいプロトコルを投げる
* ハンドシェイクする
* Heart Beatうんぬん
* WebSocket 接続

面倒ですね。  
コードに書くとこんな感じ。

<script src="https://gist.github.com/glassesfactory/0647d60bd8ce5387ede3.js">{}</script>

## 接続したあとも実は面倒くさい

Socket.IO 独自のメッセージルールがあるようなので  
送る時も受ける時もそれに合わせる必要があります。  
Socket.IO のメッセージは基本的にすべて String で  
メッセージの先頭数文字にヘッダーとしてメッセージの種類が明示されています。

主だったところだとこんな感じ

* `1::` -> コネクション
* `2::` -> ハートビート
* `3::` -> 所謂メッセージ
* `4::` -> json
* `5::` -> イベント
* `7::` -> エラー

このへん拾えればOK。

あとは受信時には WebSocket のメッセージハンドラー内で送られてきたメッセージのヘッダーをチェックする。  
送る時は逆に適切なヘッダーを付与して送る  
といったことをすればよいかと。

----------------------

で、その辺一連の流れを [FlashSocket.IO](https://github.com/simb/FlashSocket.IO ) というライブラリがやってくれてるようなのですが  
人のこと言えないですがメンテナンスが止まっているようで  
依存している WebSocket 周りのライブラリとの間でパブリッシュ時にエラーが起きてしまうようですね。

ま、というわけで接続までの流れを理屈として覚えておこうという話ですね。  
もちろん Socket.IO 側で仕様が変わったら合わせる必要はありますが  
さすがにその辺はチェンジログとかで強調されて書かれるのではないでしょうか。

とりあえず今回はこのへんで。
